@page "/info/{owner}/{repoName}"

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web

@using Markdig
@using System.Net.Http
@using premake.repositories.registry
@using premake.repositories.registry.objects
@using premake.repositories.user
@using premake.repositories.user.objects
@using premake_registry.src.frontend.Components.common.LoadingContainer
@inject UserRepositories UserRepos
@inject GitRepoRepository GitRepos
@inject HttpClient Http

<h2>@owner / @repoName</h2>


<LoadingContainer Tasks="loadTasks.ToArray()">
    @if (repo != null && userRepo != null)
    {
        <div class="info-container">
            <div class="repo-header">
                <p>@repo.RepoName</p>
                <div class="install-block">
                    <label>Install</label>
                </div>

                <div class="repo-links">
                    <a href="https://github.com/@owner/@repoName" target="_blank">Repository</a>
                    <a href="https://github.com/@owner/@repoName#readme" target="_blank">Homepage</a>
                </div>

                <div class="repo-meta">
                    <span><strong>License:</strong> @userRepo.license?.Name</span>
                    <span><strong>Published:</strong> @repo.CreatedAt.ToDateTime().ToLocalTime().ToShortDateString()</span>
                </div>

                @if (repo.tags?.Length > 0)
                {
                    <div class="tags">
                        @foreach (var tag in repo.tags)
                        {
                            <span class="tag">@tag</span>
                        }
                    </div>
                }
            </div>

            <div class="readme" @onclick:stopPropagation="true">
                @((MarkupString)readmeHtml)
            </div>
        </div>
    }
</LoadingContainer>


@code {
#nullable enable
    [Parameter] public string owner { get; set; } = string.Empty;
    [Parameter] public string repoName { get; set; } = string.Empty;

    private RegistryRepo? repo;
    private UserRepo? userRepo;
    private string readmeHtml = "<p><em>No README found.</em></p>";
    private List<Task> loadTasks = new();

    protected override void OnInitialized()
    {
        // Kick off all async work and track in loadTasks
        loadTasks.Add(LoadRepoAsync());
    }

    private async Task LoadRepoAsync()
    {
        var repos = await UserRepos.FindByUserNameAsync(owner);
        repo = repos.FirstOrDefault(r => r.RepoName.Equals(repoName, StringComparison.OrdinalIgnoreCase));

        if (repo == null)
            return;

        try
        {
            var md = await Http.GetStringAsync(repo.RepoReadme);
            readmeHtml = Markdown.ToHtml(md);
        }
        catch
        {
            readmeHtml = "<p><em>Could not load README.md</em></p>";
        }

        userRepo = await GitRepos.GetUserRepoAsync(repo);
    }
}
