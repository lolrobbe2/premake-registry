@page "/user/new_repo"

@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web

@using premake.User
@using premake.repositories.user
@using premake.repositories.user.objects
@using premake_registry.src.frontend.Components.User.UserRepo
@using premake_registry.src.frontend.Components.User.UserRepo.RepoList
@using premake_registry.src.frontend.Components.common.LoadingContainer
@inject CurrentUser user
@inject NavigationManager NavManager
@inject GitRepoRepository RepoRepo

<LoadingContainer Tasks="loadTasks">
    <RepoList Repos="repos" OnAdd="OnAddSelected"/>
</LoadingContainer>

@code {
    #nullable enable
    private UserRepo[]? repos;
    private Task[] loadTasks = Array.Empty<Task>();

    protected override void OnParametersSet()
    {
        if (!user.IsLoggedIn())
        {
            NavManager.NavigateTo("/", forceLoad: true);
        }
    }

    protected override void OnInitialized()
    {
        var fetchTask = LoadReposAsync();
        loadTasks = new[] { fetchTask };
    }

    private async Task LoadReposAsync()
    {
        repos = await RepoRepo.GetUserReposAsync();
    }

    private void OnAddSelected(UserRepo repo)
    {
        string repoParam = Uri.EscapeDataString(repo.name);
        NavManager.NavigateTo($"/user/new_repo/{repoParam}");
    }
}
